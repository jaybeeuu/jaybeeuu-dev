version: 2.1

docker-image-node: &docker-image-node
    docker:
      - image: circleci/node:12.13.1

src-dir: &src-dir ~/src

api-base: &api-base
    <<: *docker-image-node
    working_directory: ~/src/api

client-base: &client-base
    <<: *docker-image-node
    working_directory: ~/src/client

jobs:
    checkout-install-deps:
        <<: *docker-image-node

        working_directory: ~/src

        steps:
          - checkout:
              path: *src-dir

          - run: ./.devcontainer/scripts/post-create-command.sh

          - restore_cache:
                keys:
                  - v1-npm-deps-api-{{ checksum "./api/package-lock.json" }}
                  - v1-npm-deps-api
          - run: npm install --prefix ./api
          - save_cache:
                paths:
                  - node_modules
                key: v1-npm-deps-api-{{ checksum "./api/package-lock.json" }}

          - restore_cache:
                keys:
                  - v1-npm-deps-client-{{ checksum "./client/package-lock.json" }}
                  - v1-npm-deps-client
          - run: npm install --prefix ./client
          - save_cache:
                paths:
                  - node_modules
                key: v1-npm-deps-client-{{ checksum "./client/package-lock.json" }}

          - persist_to_workspace:
                root: *src-dir
                paths:
                  - ./*


    api-type-check:
        <<: *api-base

        steps:
          - attach_workspace:
                at: *src-dir
          - run: npm run-script type-check


    api-test:
        <<: *api-base

        steps:
          - attach_workspace:
                at: *src-dir
          - run: npm run-script test


    api-lint:
        <<: *api-base

        steps:
          - attach_workspace:
                at: *src-dir
          - run: npm run-script lint


    api-build:
        <<: *api-base

        steps:
          - attach_workspace:
                at: *src-dir
          - run: npm run-script build
          - store_artifacts:
              path: ./dist
              destination: api-dist



    client-type-check:
        <<: *client-base

        steps:
          - attach_workspace:
                at: *src-dir
          - run: npm run-script type-check


    client-test:
        <<: *client-base

        steps:
          - attach_workspace:
                at: *src-dir
          - run: npm run-script test


    client-lint:
        <<: *client-base

        steps:
          - attach_workspace:
                at: *src-dir
          - run: npm run-script lint


    client-build:
        <<: *client-base

        steps:
          - attach_workspace:
                at: *src-dir
          - run: npm run-script build
          - store_artifacts:
              path: ./dist
              destination: client-dist


workflows:
  version: 2

  install-test-build:
    jobs:
      - checkout-install-deps

      - api-type-check:
            requires:
              - checkout-install-deps
      - api-test:
            requires:
              - checkout-install-deps
      - api-lint:
            requires:
              - checkout-install-deps
      - api-build:
            requires:
              - checkout-install-deps

      - client-type-check:
            requires:
              - checkout-install-deps
      - client-test:
            requires:
              - checkout-install-deps
      - client-lint:
            requires:
              - checkout-install-deps
      - client-build:
            requires:
              - checkout-install-deps